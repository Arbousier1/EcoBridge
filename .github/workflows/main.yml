name: EcoBridge High-Performance Build (Java 25)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_INCREMENTAL: 0
  JAVA_TOOL_OPTIONS: "-Dfile.encoding=UTF-8"

jobs:
  # ==========================================
  # ç¬¬ä¸€é˜¶æ®µï¼šç¼–è¯‘å¤šå¹³å° Native å†…æ ¸
  # ==========================================
  build-rust:
    name: Native Core (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: libecobridge_rust.so
            # Ubuntu é»˜è®¤è¾“å‡ºè·¯å¾„é€šå¸¸åœ¨ target/release
            artifact_path: ecobridge-rust/target/release/libecobridge_rust.so
            
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: ecobridge_rust.dll
            # Windows æœ‰æ—¶ä¼šåŒ…å« target ç›®å½•ï¼Œè§†å…·ä½“é…ç½®è€Œå®šï¼Œè¿™é‡Œç»Ÿä¸€ç”¨ release
            artifact_path: ecobridge-rust/target/release/ecobridge_rust.dll
            
          - os: macos-latest
            # macOS ç‰¹æ®Šå¤„ç†ï¼Œtarget åœ¨è„šæœ¬é‡ŒæŒ‡å®šäº†å¤šæ¶æ„
            artifact_name: libecobridge_rust.dylib
            artifact_path: ecobridge-rust/target/release/libecobridge_rust.dylib

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4

      # [Windows] æ’é™¤ Defender æ‰«æä»¥åŠ é€Ÿç¼–è¯‘
      - name: Disable Windows Defender
        if: matrix.os == 'windows-latest'
        run: |
          Set-MpPreference -ExclusionPath ${{ github.workspace }}
          Write-Host "âœ… Windows Defender å·²æ’é™¤å·¥ä½œç›®å½•ã€‚"
        shell: powershell

      # [Rust] å®‰è£…å·¥å…·é“¾ï¼Œç¡®ä¿ macOS å®‰è£…äº†è·¨æ¶æ„ç›®æ ‡
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          # å…³é”®ä¿®å¤ï¼šæ˜¾å¼æ·»åŠ  macOS çš„ aarch64 å’Œ x86_64 ç›®æ ‡ï¼Œå¦åˆ™ lipo ä¼šå¤±è´¥
          targets: ${{ matrix.os == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "ecobridge-rust -> target"

      # [Rust] ç¼–è¯‘è„šæœ¬
      - name: Build Rust
        shell: bash
        env:
          # Windows ä¸‹å¼ºåˆ¶ä½¿ç”¨ LLD é“¾æ¥å™¨é˜²æ­¢å¡æ­»
          RUSTFLAGS: >-
            ${{ matrix.os == 'windows-latest' 
              && '-C link-arg=-fuse-ld=lld' 
              || '' }}
        run: |
          cd ecobridge-rust
          
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            # macOS é€šç”¨äºŒè¿›åˆ¶æ„å»º (Universal Binary)
            echo "ğŸ æ„å»º macOS x86_64..."
            cargo build --release --target x86_64-apple-darwin
            
            echo "ğŸ æ„å»º macOS aarch64 (M1/M2)..."
            cargo build --release --target aarch64-apple-darwin
            
            # åˆ›å»ºé€šç”¨åº“
            mkdir -p target/release
            lipo -create \
              target/x86_64-apple-darwin/release/libecobridge_rust.dylib \
              target/aarch64-apple-darwin/release/libecobridge_rust.dylib \
              -output target/release/libecobridge_rust.dylib
              
            echo "âœ… macOS Universal Binary æ‰“åŒ…å®Œæˆ"
          else
            # Linux & Windows æ™®é€šæ„å»º
            cargo build --release
          fi

      # [Artifact] ä¸Šä¼ ç¼–è¯‘å¥½çš„åº“æ–‡ä»¶
      - name: Upload Native Library
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.os }}
          path: ${{ matrix.artifact_path }}

      # [Artifact] ä»…ä» Ubuntu ä¸Šä¼ å¤´æ–‡ä»¶ (ç”¨äº Java é˜¶æ®µç”Ÿæˆç»‘å®š)
      - name: Upload Header File
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: rust-header
          path: ecobridge-rust/ecobridge_rust.h

  # ==========================================
  # ç¬¬äºŒé˜¶æ®µï¼šç”Ÿæˆ Java ç»‘å®šå¹¶æ‰“åŒ…
  # ==========================================
  build-java:
    name: Java 25 Assembly
    needs: build-rust
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      # [Java] å®‰è£… JDK 25 (Early Access)
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          # ä½¿ç”¨ oracle-graalvm-ea-25 æˆ– openjdk 25
          distribution: 'temurin' 
          # å¦‚æœ temurin æ²¡æœ‰ 25ï¼Œå¯ä»¥æ¢æˆ 'oracle'
          cache: 'gradle'

      # [Jextract] å®‰è£… FFM ç»‘å®šç”Ÿæˆå·¥å…·
      - name: Setup jextract
        run: |
          # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ JDK 22 çš„ jextract æ˜¯æƒå®œä¹‹è®¡ã€‚
          # å¦‚æœ Java 25 çš„ FFM API æœ‰é‡å¤§å˜æ›´ï¼Œå¯èƒ½éœ€è¦å¯»æ‰¾æ›´æ–°çš„ jextract ç‰ˆæœ¬ã€‚
          # æˆªè‡³ç›®å‰ï¼Œjextract ä¸»è¦å‘å¸ƒåœ¨ JDK 22 EA é˜¶æ®µã€‚
          
          DOWNLOAD_URL="https://download.java.net/java/early_access/jextract/22/4/openjdk-22-jextract+4-30_linux-x64_bin.tar.gz"
          
          echo "â¬‡ï¸ Downloading jextract..."
          wget -q $DOWNLOAD_URL -O jextract.tar.gz
          
          mkdir -p jextract_bin
          tar -xzf jextract.tar.gz -C jextract_bin --strip-components=1
          
          # å…³é”®ä¿®å¤ï¼šèµ‹äºˆæ‰§è¡Œæƒé™ï¼
          chmod +x jextract_bin/bin/jextract
          
          # æ³¨å…¥ç¯å¢ƒå˜é‡
          echo "JEXTRACT_HOME=$(pwd)/jextract_bin" >> $GITHUB_ENV
          echo "âœ… jextract å®‰è£…å®Œæ¯•: $(pwd)/jextract_bin/bin/jextract"

      # [Artifact] æ¢å¤å¤´æ–‡ä»¶
      - name: Restore Header File
        uses: actions/download-artifact@v4
        with:
          name: rust-header
          path: ecobridge-rust

      # [Artifact] æ¢å¤æ‰€æœ‰å¹³å°çš„ Native åº“
      - name: Download Native Libs
        uses: actions/download-artifact@v4
        with:
          path: native-libs
          pattern: native-*
          merge-multiple: true

      # [Resource] å°† Native åº“æ³¨å…¥åˆ° Java èµ„æºç›®å½•
      - name: Prepare Resources
        run: |
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p ecobridge-java/src/main/resources/natives
          
          # å¤åˆ¶æ–‡ä»¶ (å¹³é“ºç»“æ„)
          cp native-libs/* ecobridge-java/src/main/resources/natives/
          
          echo "ğŸ“¦ èµ„æºç›®å½•å†…å®¹:"
          ls -R ecobridge-java/src/main/resources/natives/

      # [Gradle] æ„å»º JAR
      - name: Build with Gradle
        working-directory: ecobridge-java
        run: |
          chmod +x gradlew
          
          # 1. ç”Ÿæˆç»‘å®š (éœ€è¦ ecobridge-rust/ecobridge_rust.h)
          # 2. æ‰“åŒ… (ShadowJar ä¼šè‡ªåŠ¨åŒ…å« resources/natives ä¸‹çš„ .dll/.so/.dylib)
          ./gradlew clean generateBindings shadowJar -x test --no-daemon

      # [Artifact] ä¸Šä¼ æœ€ç»ˆäº§ç‰©
      - name: Upload Final Jar
        uses: actions/upload-artifact@v4
        with:
          name: EcoBridge-Java25-Build
          path: ecobridge-java/build/libs/*-all.jar
