è¿™ä¸€æ¬¡çš„æŠ¥é”™ä¿¡æ¯éå¸¸æ¸…æ™°ï¼Œä¸»è¦æš´éœ²äº†ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
 * ç¼ºå°‘ç¬¬ä¸‰æ–¹åº“ä¾èµ–ï¼šä½ çš„ä»£ç ä¸­ä½¿ç”¨äº† Jackson (ObjectMapper) å’Œ PlaceholderAPI (PlaceholderExpansion)ï¼Œä½† build.gradle.kts ä¸­å®Œå…¨æ²¡æœ‰æ·»åŠ å®ƒä»¬çš„ä¾èµ–ï¼Œå¯¼è‡´äº† 20 å¤šä¸ª package does not exist é”™è¯¯ã€‚
 * ç”Ÿæˆä»»åŠ¡æœªæ‰§è¡Œæˆ–è·¯å¾„é”™è¯¯ï¼štop.ellan.ecobridge.gen åŒ…ä¸å­˜åœ¨ï¼Œè¯´æ˜ generateBindings ä»»åŠ¡è¦ä¹ˆæ²¡è·‘ï¼Œè¦ä¹ˆç”Ÿæˆçš„è·¯å¾„æ²¡è¢« Java ç¼–è¯‘å™¨è¯†åˆ«ã€‚
è¿™é‡Œæ˜¯ä¿®å¤åçš„å®Œæ•´ build.gradle.ktsã€‚
ğŸ› ï¸ å…³é”®ä¿®å¤ç‚¹ (Changelog)
 * [æ–°å¢] ä»“åº“åœ°å€ï¼šæ·»åŠ äº† repo.extendedclip.com ä»¥æ”¯æŒä¸‹è½½ PlaceholderAPIã€‚
 * [æ–°å¢] æ ¸å¿ƒä¾èµ–ï¼š
   * æ·»åŠ  jackson-databind (è§£å†³ ObjectMapper æ‰¾ä¸åˆ°çš„é—®é¢˜)ã€‚
   * æ·»åŠ  placeholderapi (è§£å†³ EcoPlaceholderExpansion æŠ¥é”™)ã€‚
 * [å¼ºåŒ–] æ„å»ºé¡ºåºï¼šåœ¨ compileJava ä¸­æ˜¾å¼æ·»åŠ  dependsOn(generateBindings)ï¼Œå¹¶å¼ºåˆ¶å°†ç”Ÿæˆçš„æºç ç›®å½•æ³¨å†Œåˆ° sourceSetsï¼Œç¡®ä¿ç¼–è¯‘å™¨èƒ½æ‰¾åˆ° jextract ç”Ÿæˆçš„ä»£ç ã€‚
âœ… å®Œæ•´æ›¿æ¢ ecobridge-java/build.gradle.kts
è¯·ç›´æ¥å¤åˆ¶ä»¥ä¸‹ä»£ç è¦†ç›–åŸæ–‡ä»¶ï¼š
import com.github.jengelman.gradle.plugins.shadow.tasks.ShadowJar
import java.util.Properties

buildscript {
    repositories {
        mavenCentral()
        gradlePluginPortal()
    }
    dependencies {
        // é’ˆå¯¹ Java 25 ä¼˜åŒ–çš„ ASM å­—èŠ‚ç å¤„ç†å·¥å…·
        classpath("org.ow2.asm:asm-commons:9.9.1")
    }
}

plugins {
    `java-library`
    // 2026å¹´ 1æœˆæœ€æ–°ç¨³å®šç‰ˆ Shadow æ’ä»¶
    id("com.gradleup.shadow") version "8.3.6"
}

group = "top.ellan"
version = "1.0-SNAPSHOT"

// --- [jextract è‡ªåŠ¨åŒ–é…ç½®é€»è¾‘] ---
// ç¡®ä¿è·¯å¾„æŒ‡å‘ artifact ä¸‹è½½åçš„ä½ç½®
val rustHeaderFile = file("${projectDir}/../ecobridge-rust/ecobridge_rust.h")
val generatedSourceDir = layout.buildDirectory.dir("generated/sources/jextract")
val targetPackage = "top.ellan.ecobridge.gen"

// ğŸ” æ™ºèƒ½æŸ¥æ‰¾ jextract å¯åŠ¨è„šæœ¬
fun findJextract(): String {
    val os = org.gradle.internal.os.OperatingSystem.current()
    val binaryName = if (os.isWindows) "jextract.bat" else "jextract"
    
    // 1. ä¼˜å…ˆè¯»å– local.properties
    val localPropsFile = file("local.properties")
    if (localPropsFile.exists()) {
        val props = Properties()
        localPropsFile.inputStream().use { props.load(it) }
        val localHome = props.getProperty("jextract.home")
        if (localHome != null) {
            val possiblePaths = listOf(
                file("$localHome/bin/$binaryName"),
                file("$localHome/$binaryName")
            )
            for (path in possiblePaths) {
                if (path.exists()) {
                    println("âœ… [Local] æ‰¾åˆ° jextract è„šæœ¬: ${path.absolutePath}")
                    return path.absolutePath
                }
            }
        }
    }

    // 2. å°è¯•ç¯å¢ƒå˜é‡
    val envHome = System.getenv("JEXTRACT_HOME")
    if (envHome != null) {
        val path = file("$envHome/bin/$binaryName")
        if (path.exists()) return path.absolutePath
    }

    // 3. å°è¯• JAVA_HOME
    val javaHome = System.getProperty("java.home")
    val jdkPath = file("$javaHome/bin/$binaryName")
    if (jdkPath.exists()) return jdkPath.absolutePath

    return binaryName
}

// æ ¸å¿ƒä»»åŠ¡ï¼šè‡ªåŠ¨åŒ–ç”Ÿæˆ Java ç»‘å®š
val generateBindings = tasks.register<Exec>("generateBindings") {
    group = "build"
    description = "ä½¿ç”¨ jextract è‡ªåŠ¨ä» Rust å¤´æ–‡ä»¶ç”Ÿæˆ Java FFM ç»‘å®šã€‚"

    // ç¡®ä¿ç›®å½•å­˜åœ¨
    doFirst {
        if (!rustHeaderFile.exists()) {
            // åœ¨ CI ç¯å¢ƒä¸‹ï¼Œæ‰“å°å½“å‰ç›®å½•ç»“æ„å¸®åŠ©è°ƒè¯•
            println("âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°å¤´æ–‡ä»¶: ${rustHeaderFile.absolutePath}")
            println("å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:")
            projectDir.parentFile.listFiles()?.forEach { println(" - ${it.name}") }
            throw GradleException("Rust å¤´æ–‡ä»¶ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥ build-rust é˜¶æ®µæ˜¯å¦æˆåŠŸä¸Šä¼ äº† artifactã€‚")
        }
        generatedSourceDir.get().asFile.mkdirs()
    }

    commandLine(
        findJextract(),
        "--output", generatedSourceDir.get().asFile.absolutePath,
        "--target-package", targetPackage,
        // ğŸ”¥ å¼ºåˆ¶æŒ‡å®š header class nameï¼Œç¡®ä¿ Java ä»£ç èƒ½å¼•ç”¨åˆ° ecobridge_rust_h
        "--header-class-name", "ecobridge_rust_h",
        "--library", "ecobridge_rust",
        rustHeaderFile.absolutePath
    )

    inputs.file(rustHeaderFile)
    outputs.dir(generatedSourceDir)
}

// --- [Java ç¼–è¯‘ä¸å·¥å…·é“¾é…ç½®] ---
java {
    toolchain { languageVersion.set(JavaLanguageVersion.of(25)) }
}

// å°†ç”Ÿæˆçš„ä»£ç åŠ å…¥æºä»£ç é›†
sourceSets {
    main {
        // âœ… å…³é”®ï¼šå°†ä»»åŠ¡è¾“å‡ºæ³¨å†Œä¸ºæºç ç›®å½•
        // è¿™ä¼šè‡ªåŠ¨å»ºç«‹ compileJava -> generateBindings çš„ä¾èµ–å…³ç³»
        java.srcDir(generateBindings)
    }
}

repositories {
    mavenCentral()
    maven("https://jitpack.io")
    maven("https://repo.papermc.io/repository/maven-public/")
    maven("https://repo.nightexpressdev.com/releases")
    maven("https://repo.lanink.cn/repository/maven-public/")
    // âœ… æ–°å¢ï¼šPlaceholderAPI ä»“åº“
    maven("https://repo.extendedclip.com/content/repositories/placeholderapi/")
    flatDir { dirs("libs") }
}

dependencies {
    // Spigot/Paper API
    compileOnly("io.papermc.paper:paper-api:1.21.1-R0.1-SNAPSHOT")
    
    // âœ… æ–°å¢ï¼šPlaceholderAPI ä¾èµ– (è§£å†³ EcoPlaceholderExpansion æŠ¥é”™)
    compileOnly("me.clip:placeholderapi:2.11.6")

    // å…¶ä»–æ’ä»¶ä¾èµ–
    compileOnly(fileTree(mapOf("dir" to "libs", "include" to listOf("**/*.jar"))))
    compileOnly("su.nightexpress.nightcore:main:2.13.0")
    compileOnly("su.nightexpress.coinsengine:CoinsEngine:2.6.0")
    compileOnly("cn.superiormc.ultimateshop:plugin:4.2.3")
    
    // æ•°æ®åº“ä¸å·¥å…·åº“
    implementation("org.mariadb.jdbc:mariadb-java-client:3.3.2")
    implementation("com.zaxxer:HikariCP:5.1.0")
    implementation("com.github.ben-manes.caffeine:caffeine:3.1.8")
    implementation("redis.clients:jedis:5.1.0")
    
    // âœ… æ–°å¢ï¼šJackson ä¾èµ– (è§£å†³ ObjectMapper/JsonProcessingException æŠ¥é”™)
    implementation("com.fasterxml.jackson.core:jackson-databind:2.16.1")
    implementation("com.fasterxml.jackson.core:jackson-core:2.16.1")
    implementation("com.fasterxml.jackson.core:jackson-annotations:2.16.1")
    
    compileOnly("com.google.code.gson:gson:2.10.1")

    // æµ‹è¯•ä¾èµ–
    testImplementation(platform("org.junit:junit-bom:5.10.2"))
    testImplementation("org.junit.jupiter:junit-jupiter")
}

tasks.test {
    useJUnitPlatform()
}

tasks.withType<JavaCompile> {
    // ğŸ”’ åŒé‡ä¿é™©ï¼šå¼ºåˆ¶ç¼–è¯‘ä»»åŠ¡ä¾èµ–äºç»‘å®šç”Ÿæˆ
    dependsOn(generateBindings)
    
    options.encoding = "UTF-8"
    options.release.set(25)
    options.compilerArgs.addAll(listOf(
        "--enable-preview",
        "-Xlint:unchecked",
        "-Xlint:-preview"
    ))
}

tasks.named<ShadowJar>("shadowJar") {
    archiveClassifier.set("")
    val prefix = "top.ellan.ecobridge.libs"
    
    // é‡å®šä½ä¾èµ–ï¼Œé˜²æ­¢å†²çª
    relocate("com.zaxxer.hikari", "$prefix.hikari")
    relocate("org.mariadb.jdbc", "$prefix.mariadb")
    relocate("com.github.benmanes.caffeine", "$prefix.caffeine")
    relocate("redis.clients", "$prefix.jedis")
    relocate("com.fasterxml.jackson", "$prefix.jackson") // âœ… é‡å®šä½ Jackson
    
    from("src/main/resources") {
        include("*.dll", "*.so", "*.dylib", "natives/**")
    }
    
    mergeServiceFiles()
}

tasks.withType<ProcessResources> {
    val props = mapOf("version" to project.version)
    inputs.properties(props)
    filesMatching("plugin.yml") {
        expand(props)
    }
}

