name: EcoBridge High-Performance Build (Java 25)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # å…¨å±€å¯ç”¨ sccache åŒ…è£…å™¨ (å…³é”®åŠ é€Ÿé…ç½®)
  RUSTC_WRAPPER: "sccache"
  SCCACHE_GHA_ENABLED: "true"
  # é…åˆ sccache å¿…é¡»å…³é—­å¢é‡ç¼–è¯‘
  CARGO_INCREMENTAL: 0
  JAVA_TOOL_OPTIONS: "-Dfile.encoding=UTF-8"

jobs:
  # ==========================================
  # ç¬¬ä¸€é˜¶æ®µï¼šç¼–è¯‘å¤šå¹³å° Native å†…æ ¸
  # ==========================================
  build-rust:
    name: Native Core (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: libecobridge_rust.so
            artifact_path: ecobridge-rust/target/release/libecobridge_rust.so
          - os: windows-latest
            artifact_name: ecobridge_rust.dll
            # Windows æœ‰æ—¶ä¼šåŒ…å« target ç›®å½•ï¼Œè¿™é‡Œè·¯å¾„éœ€è¦ç²¾ç¡®
            artifact_path: ecobridge-rust/target/release/ecobridge_rust.dll
          - os: macos-latest
            artifact_name: libecobridge_rust.dylib
            artifact_path: ecobridge-rust/target/release/libecobridge_rust.dylib

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4

      # [Windows] æ’é™¤ Defender æ‰«æä»¥é˜²æ­¢ I/O å¡æ­»
      # âš ï¸ ä¿®å¤ï¼šshell å¿…é¡»ä¸ run å¯¹é½ï¼Œä¸èƒ½ç¼©è¿›åˆ° run é‡Œé¢
      - name: Disable Windows Defender
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Set-MpPreference -ExclusionPath ${{ github.workspace }}

      # [Rust] å®‰è£…å·¥å…·é“¾
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          # macOS éœ€è¦å®‰è£… x86_64 å’Œ aarch64 ä¸¤ä¸ªç›®æ ‡ä»¥æ„å»ºé€šç”¨äºŒè¿›åˆ¶
          targets: ${{ matrix.os == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      # [Cache] å¯ç”¨ sccache (ç¼–è¯‘å™¨çº§ç¼“å­˜ï¼Œå¯¹ Windows æå…¶æœ‰æ•ˆ)
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.5

      # [Cache] å¯ç”¨ä¾èµ–é¡¹ç¼“å­˜ (è¾…åŠ©åŠ é€Ÿ)
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "ecobridge-rust -> target"
          key: ${{ matrix.os }}-cargo-v2
          cache-on-failure: true

      # [Build] ç¼–è¯‘è„šæœ¬
      - name: Build Rust
        shell: bash
        env:
          # Windows ä¸‹å¼ºåˆ¶ä½¿ç”¨ LLD é“¾æ¥å™¨ï¼Œé˜²æ­¢å¤§æ–‡ä»¶é“¾æ¥å¡æ­»
          RUSTFLAGS: >-
            ${{ matrix.os == 'windows-latest' 
              && '-C link-arg=-fuse-ld=lld' 
              || '' }}
        run: |
          cd ecobridge-rust
          
          # æ‰“å°åˆå§‹ç¼“å­˜ç»Ÿè®¡
          sccache --show-stats
          
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            echo "ğŸ æ„å»º macOS é€šç”¨äºŒè¿›åˆ¶ (Universal Binary)..."
            cargo build --release --target x86_64-apple-darwin
            cargo build --release --target aarch64-apple-darwin
            
            mkdir -p target/release
            # åˆå¹¶æ¶æ„
            lipo -create \
              target/x86_64-apple-darwin/release/libecobridge_rust.dylib \
              target/aarch64-apple-darwin/release/libecobridge_rust.dylib \
              -output target/release/libecobridge_rust.dylib
          else
            # Linux & Windows æ™®é€šæ„å»º
            cargo build --release
          fi
          
          # æ‰“å°æœ€ç»ˆç¼“å­˜ç»Ÿè®¡
          sccache --show-stats

      # [Artifact] ä¸Šä¼ ç¼–è¯‘å¥½çš„åº“æ–‡ä»¶
      - name: Upload Native Library
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.os }}
          path: ${{ matrix.artifact_path }}

      # [Artifact] ä»…ä» Ubuntu ä¸Šä¼ å¤´æ–‡ä»¶ (ä¾› Java é˜¶æ®µä½¿ç”¨)
      - name: Upload Header File
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: rust-header
          path: ecobridge-rust/ecobridge_rust.h

  # ==========================================
  # ç¬¬äºŒé˜¶æ®µï¼šç”Ÿæˆ Java ç»‘å®šå¹¶æ‰“åŒ…
  # ==========================================
  build-java:
    name: Java 25 Assembly
    needs: build-rust
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      # [Java] è®¾ç½® JDK 25 ç¯å¢ƒ
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin' # è‹¥ Temurin 25 ä¸å¯ç”¨ï¼Œå¯å°è¯• 'oracle' æˆ– 'zulu'
          cache: 'gradle'

      # [Jextract] å®‰è£… FFM ç»‘å®šç”Ÿæˆå·¥å…· (ä½¿ç”¨ JDK 22 EA ç‰ˆæœ¬ä½œä¸ºå…¼å®¹æ–¹æ¡ˆ)
      - name: Setup jextract
        run: |
          DOWNLOAD_URL="https://download.java.net/java/early_access/jextract/22/4/openjdk-22-jextract+4-30_linux-x64_bin.tar.gz"
          
          echo "â¬‡ï¸ Downloading jextract..."
          wget -q $DOWNLOAD_URL -O jextract.tar.gz
          
          mkdir -p jextract_bin
          tar -xzf jextract.tar.gz -C jextract_bin --strip-components=1
          
          # èµ‹äºˆæ‰§è¡Œæƒé™ (å…³é”®ä¿®å¤)
          chmod +x jextract_bin/bin/jextract
          
          echo "JEXTRACT_HOME=$(pwd)/jextract_bin" >> $GITHUB_ENV
          echo "âœ… jextract å®‰è£…å®Œæ¯•"

      # [Artifact] ä¸‹è½½å¤´æ–‡ä»¶
      - name: Restore Header File
        uses: actions/download-artifact@v4
        with:
          name: rust-header
          path: ecobridge-rust

      # [Artifact] ä¸‹è½½æ‰€æœ‰å¹³å°çš„ Native åº“
      - name: Download Native Libs
        uses: actions/download-artifact@v4
        with:
          path: native-libs
          pattern: native-*
          merge-multiple: true

      # [Resource] æ³¨å…¥èµ„æº
      # æ³¨æ„ï¼šç›´æ¥æ”¾å…¥ resources æ ¹ç›®å½•ï¼Œä»¥åŒ¹é… NativeBridge.java ä¸­ plugin.getResource(name) çš„é€»è¾‘
      - name: Prepare Resources
        run: |
          mkdir -p ecobridge-java/src/main/resources/
          cp native-libs/* ecobridge-java/src/main/resources/
          
          echo "ğŸ“¦ æœ€ç»ˆèµ„æºåˆ—è¡¨:"
          ls -l ecobridge-java/src/main/resources/

      # [Gradle] æ„å»ºæœ€ç»ˆ Jar
      - name: Build with Gradle
        working-directory: ecobridge-java
        run: |
          chmod +x gradlew
          # æ˜¾å¼è¿è¡Œ generateBindings ç¡®ä¿ Java ä»£ç ç”Ÿæˆ
          ./gradlew clean generateBindings shadowJar -x test --no-daemon

      # [Artifact] ä¸Šä¼ æœ€ç»ˆäº§ç‰©
      - name: Upload Final Jar
        uses: actions/upload-artifact@v4
        with:
          name: EcoBridge-Release
          path: ecobridge-java/build/libs/*-all.jar
          retention-days: 90
